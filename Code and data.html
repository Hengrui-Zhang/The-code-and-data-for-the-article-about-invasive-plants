
##general linear models
> anova_richness <- aov(tot.re.richness_ruqin ~ way * year, data = dd)
> summary(anova_richness)
            Df  Sum Sq Mean Sq F value   Pr(>F)    
way          1 0.00606 0.00606   4.954    0.032 *  
year         1 0.05137 0.05137  41.962 1.26e-07 ***
way:year     1 0.02411 0.02411  19.690 7.56e-05 ***
Residuals   38 0.04652 0.00122



> anova_cover <- aov(tot.re.cover_ruqin ~ way * year, data = dd)
> summary(anova_cover)
            Df  Sum Sq Mean Sq F value   Pr(>F)    
way          1 0.01387 0.01387   4.285   0.0453 *  
year         1 0.06382 0.06382  19.710 7.51e-05 ***
way:year     1 0.01763 0.01763   5.445   0.0250 *  
Residuals   38 0.12305 0.00324                     
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
> 




##univariate regression
fm <- lm(sqrt(tot.re.richness_ruqin) ~ log(year), data = dd)
res <- residuals(fm)
sw <- shapiro.test(res)
print(sw)


names.val = colnames(dd)[c(3,8:14,21,51,53,56,62,63,82:87,89:104)]
ff = dd[,c("tot.re.richness_ruqin","tot.re.cover_ruqin")]
ee = dd[,names.val]
result.r2=matrix(NA,nrow=dim(ee)[2],ncol=dim(ff)[2])
result.p=matrix(NA,nrow=dim(ee)[2],ncol=dim(ff)[2])
result.ef=matrix(NA,nrow=dim(ee)[2],ncol=dim(ff)[2])
colnames(result.r2) = colnames(result.p) = colnames(result.ef) = colnames(ff)
rownames(result.r2) = rownames(result.p) = rownames(result.ef) = colnames(ee)

for (j in 1:dim(ff)[2]) {
  y = sqrt(ff[,j]) 
  for (i in 1:dim(ee)[2]) {
    x = ee[,i]
    fm = lm(y ~ x, data = dd)
    r2 = summary(fm)$ r.squared 
    ef = summary(fm)$coefficients[2,1]
    
    p = summary(fm)$coefficients[2,4]
    
    result.r2[i,j] = summary(fm)$ r.squared
    result.ef[i,j] = summary(fm)$coefficients[2,1]
    result.p[i,j] = summary(fm)$coefficients[2,4]
    ##result.bootstrap[i,1]=ss.glm(mm)[1]
    ##result.bootstrap[i,1]=summary(mm)$r.square
    ##result.bootstrap[i,2]=ss$p.value
    ##p.result[i,j]=output.p(ccc[1],1,ccc[2])
    print(c(i))
  }
}




options(scipen = 9999) 
result.r2
result.p
result.ef
> result.r2
                      tot.re.richness_ruqin tot.re.cover_ruqin
way                           0.01036003317     0.028694429966
pH                            0.05849397358     0.044969562580
TC                            0.35158053361     0.254907892001
TN                            0.33878605862     0.210595039141
TP                            0.08103552646     0.128981428489
C比N                          0.11673062067     0.158620092392
C比P                          0.02867128146     0.017359575240
N比P                          0.01183189385     0.004563237550
含水率                        0.00919064263     0.039500274315
tot.richness_qiao             0.24455406215     0.120547309926
tot.cover_qiao                0.38568570911     0.213973996100
tot.richness_herb             0.01116935025     0.000169573859
tot.richness_guan_all         0.41166434124     0.353965505618
tot.cover_guan_all            0.13661844100     0.136763915197
herb_Faith_PD                 0.07928606435     0.124045448113
herb_ses.mpd_PD               0.09323726015     0.162755439817
mpd.谱系_herb                 0.07144139169     0.120591538843
herb_FD                       0.09424399113     0.084753822436
mpd.功能_herb                 0.03796543722     0.063791914667
herb_ses.mpd.功能             0.00271598530     0.001476912428
guan_Faith_PD                 0.36159821031     0.355260951331
guan_ses.mpd_谱系             0.01678310432     0.001085530346
guan_mpd.谱系                 0.17547201328     0.170020036335
guan_FD                       0.39422838811     0.350965478119
guan_mpd.功能                 0.19229776455     0.143777708037
guan_ses.mpd.功能             0.00055325882     0.000003141814
qiao_Faith_PD                 0.29854167970     0.156455714495
qiao_ses.mpd_谱系             0.00002999357     0.000051222747
qiao_mpd.谱系                 0.04472101590     0.016845604275
qiao_FD                       0.29406751270     0.169134558686
qiao_mpd.功能                 0.16709673525     0.099655023345
qiao_ses.mpd.功能             0.00136026352     0.000577318694
PC1                           0.29717284861     0.228574148964
PC2                           0.02448663372     0.038337505174
PC3                           0.02553497651     0.064334929091
log.year                      0.50023018680     0.509304664966
> result.p
                      tot.re.richness_ruqin tot.re.cover_ruqin
way                         0.5212631670876    0.2835204969163
pH                          0.1228042890195    0.1775860563375
TC                          0.0000350675422    0.0006499058708
TN                          0.0000526923833    0.0022373245265
TP                          0.0676712002380    0.0195027562255
C比N                        0.0267949682942    0.0089945342506
C比P                        0.2837176474197    0.4055552035658
N比P                        0.4928996619096    0.6707931662618
含水率                      0.5458845501658    0.2070252682709
tot.richness_qiao           0.0008717825785    0.0242720673434
tot.cover_qiao              0.0000114207378    0.0020397601996
tot.richness_herb           0.5053360000782    0.9347667210562
tot.richness_guan_all       0.0000046739965    0.0000324785516
tot.cover_guan_all          0.0159910667453    0.0159306302338
herb_Faith_PD               0.0708387179926    0.0221677333298
herb_ses.mpd_PD             0.0492518244629    0.0080666433449
mpd.谱系_herb               0.0870405259671    0.0242442610306
herb_FD                     0.0479812897209    0.0614128004765
mpd.功能_herb               0.2162583196278    0.1065855479534
herb_ses.mpd.功能           0.7430819846812    0.8090654740793
guan_Faith_PD               0.0000253659071    0.0000311500059
guan_ses.mpd_谱系           0.4135316965771    0.8359038345383
guan_mpd.谱系               0.0057613979654    0.0066579348252
guan_FD                     0.0000085467554    0.0000357665814
guan_mpd.功能               0.0036740650791    0.0132689677419
guan_ses.mpd.功能           0.8824560455843    0.9911113134749
qiao_Faith_PD               0.0001815698068    0.0095210109392
qiao_ses.mpd_谱系           0.9725408199613    0.9641204854900
qiao_mpd.谱系               0.1788168283433    0.4126560255963
qiao_FD                     0.0002075513422    0.0068158464607
qiao_mpd.功能               0.0071932743480    0.0416986609462
qiao_ses.mpd.功能           0.8166261365650    0.8799456438447
PC1                         0.0001891674937    0.0013635489560
PC2                         0.3223556279333    0.2139773307880
PC3                         0.3120823690299    0.1050565072570
log.year                    0.0000001637599    0.0000001125835966
> result.ef
                      tot.re.richness_ruqin tot.re.cover_ruqin
way                            0.0296913994      0.05136847880
pH                             0.0336888647      0.03070704002
TC                            -0.0454714442     -0.04024999101
TN                            -0.6172723560     -0.50592476708
TP                            -0.0894475531     -0.11731191825
C比N                          -0.0238896473     -0.02894971217
C比P                          -0.0037167353     -0.00300646008
N比P                          -0.0113931902     -0.00735533680
含水率                        -0.2477251080     -0.53388159833
tot.richness_qiao             -0.0082490203     -0.00602062395
tot.cover_qiao                -0.0003958479     -0.00030650665
tot.richness_herb              0.0031377715      0.00040191538
tot.richness_guan_all         -0.0109342649     -0.01054013674
tot.cover_guan_all            -0.0031864954     -0.00331430300
herb_Faith_PD                 -0.0005788426     -0.00075266244
herb_ses.mpd_PD               -0.0406757198     -0.05586709145
mpd.谱系_herb                 -0.0005674823     -0.00076644961
herb_FD                       -0.7550799222     -0.74437802559
mpd.功能_herb                  0.6035047695      0.81323700440
herb_ses.mpd.功能             -0.0077369190     -0.00593102188
guan_Faith_PD                 -0.0001130713     -0.00011650937
guan_ses.mpd_谱系              0.0442045525     -0.01168690855
guan_mpd.谱系                 -0.0008916840     -0.00091244129
guan_FD                       -0.3002150007     -0.29446823347
guan_mpd.功能                 -0.8272938077     -0.74364599509
guan_ses.mpd.功能             -0.0034683858     -0.00027170728
qiao_Faith_PD                 -0.0001162092     -0.00008745440
qiao_ses.mpd_谱系             -0.0005606853     -0.00076170066
qiao_mpd.谱系                 -0.0001231216     -0.00007855421
qiao_FD                       -0.2021047556     -0.15933713188
qiao_mpd.功能                 -0.9141618837     -0.73389940226
qiao_ses.mpd.功能              0.0061025827      0.00413292730
PC1                           -0.0460914385     -0.04202203340
PC2                            0.0166921580      0.02171239231
PC3                            0.0217634401      0.03591129246
log.year                      -0.1133594371     -0.11890753314





###pca
dd = read.csv("汇总.csv",fileEncoding= "UTF-8")

soil.A = dd[,c(8:14,21)]
pcaA = prcomp(soil.A, scale=TRUE)
summary(pcaA)
Importance of components:
                         PC1    PC2    PC3    PC4     PC5    PC6     PC7     PC8
Standard deviation     1.746 1.3839 1.0839 0.9602 0.67672 0.5514 0.41849 0.05032
Proportion of Variance 0.381 0.2394 0.1469 0.1152 0.05724 0.0380 0.02189 0.00032
Cumulative Proportion  0.381 0.6204 0.7673 0.8825 0.93979 0.9778 0.99968 1.00000
pca.soil = pcaA$x[,1:3]
write.csv(pca.soil, "pca.soil.csv")







## plot
library(ggplot2)
library(dplyr)
library(broom)
model_results <- data %>%
  group_by(way) %>%
  group_modify(~ {
    formula_used <- if (.y$way == "TR") {
      tot.re.richness_ruqin ~ log(as.numeric(year))
    } else {
      tot.re.richness_ruqin ~ as.numeric(year)
    }
    
    model <- lm(formula_used, data = .x)
    tidy_model <- glance(model)
    
    tibble(R_squared = tidy_model$r.squared,
           p_value = tidy_model$p.value)
  })

print(model_results)
ggplot(data, aes(x = as.numeric(year), y = tot.re.richness_ruqin, color = way)) +
  geom_point(size = 6) + 
  geom_smooth(method = 'lm', formula = y ~ log(x), se = TRUE, linewidth = 2, fill = "lightgray", 
              data = function(x) subset(x, way == "TR")) +
  geom_smooth(method = 'lm', formula = y ~ x, se = TRUE, linewidth = 2, fill = "lightgray", 
              data = function(x) subset(x, way == "RG")) +
  scale_color_manual(values = c("RG" = "#F8766D", "TR" = "#00BFC4")) +
  scale_x_continuous(limits = c(0, 45)) +
  scale_y_continuous(limits = c(-0.05, 0.25)) +
  theme(
    panel.background = element_blank(), 
    panel.border = element_rect(color = "black", linewidth = 1.8, fill = NA), 
    axis.text = element_text(size = 22),   
    axis.ticks.length = unit(0.25, "cm"),
    axis.ticks = element_line(color = "black", linewidth = 1),
    axis.title = element_text(size = 18)   
  )


#
model_results <- data %>%
  group_by(way) %>%
  group_modify(~ {
    formula_used <- if (.y$way == "TR") {
      tot.re.cover_ruqin ~ log(as.numeric(year))
    } else {
      tot.re.cover_ruqin ~ as.numeric(year)
    }
    
    model <- lm(formula_used, data = .x)
    tidy_model <- glance(model)
    
    tibble(R_squared = tidy_model$r.squared,
           p_value = tidy_model$p.value)
  })

print(model_results)

ggplot(data, aes(x = as.numeric(year), y = tot.re.cover_ruqin, color = way)) +
  geom_point(size = 6) +  # 点的大小改为 4
  geom_smooth(method = 'lm', formula = y ~ log(x), se = TRUE, linewidth = 2, fill = "lightgray", 
              data = function(x) subset(x, way == "TR")) +
  geom_smooth(method = 'lm', formula = y ~ x, se = TRUE, linewidth = 2, fill = "lightgray", 
              data = function(x) subset(x, way == "RG")) +
  scale_color_manual(values = c("RG" = "#F8766D", "TR" = "#00BFC4")) +
  scale_x_continuous(limits = c(0, 45)) +
  scale_y_continuous(limits = c(-0.05, 0.4)) +
  theme(
    panel.background = element_blank(), 
    panel.border = element_rect(color = "black", linewidth = 1.8, fill = NA),  # 边框更粗
    axis.text = element_text(size = 22),   # x、y轴刻度标签字体大小
    axis.ticks.length = unit(0.25, "cm"),
    axis.ticks = element_line(color = "black", linewidth = 1),
    axis.title = element_text(size = 18)   # x、y轴标题大小（如果你设置了标题）
  )






#t-test
t_test_richness <- t.test(tot.re.richness_ruqin ~ way, data = data)
t_test_cover <- t.test(tot.re.cover_ruqin ~ way, data = data)

wailai$group <- factor(wailai$group, levels = c("0-15年", "15-30年", "30-45年"))


ggboxplot(wailai, 
          x = "group",
          y = "sqrt(tot.re.richness_ruqin)",
          color = "way",
          width = 0.7,
          lwd = 1.5) +  
  scale_color_manual(values = c("#F8766D", "#00BFC4")) +
  stat_compare_means(aes(group = way), 
                     method = "t.test", 
                     label = "p.signif", 
                     show.legend = FALSE) +
  scale_y_continuous(limits = c(0, 0.25)) +
  labs(x = "恢复年限", y = "入侵种相对丰富度") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black", linewidth = 1),
    panel.border = element_rect(colour = "black", linewidth = 1.4, fill = NA)  
  )





wailai$group <- factor(wailai$group, levels = c("0-15年", "15-30年", "30-45年"))

ggboxplot(wailai, 
          x = "group",
          y = "tot.re.cover_ruqin",
          color = "way",
          width = 0.7,
          lwd = 1.5) +  
  scale_color_manual(values = c("#F8766D", "#00BFC4")) +
  stat_compare_means(aes(group = way), 
                     method = "t.test", 
                     label = "p.signif", 
                     show.legend = FALSE) +
  scale_y_continuous(limits = c(0.00, 0.40)) +
  labs(x = "恢复年限", y = "入侵种相对盖度") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black", linewidth = 1),
    panel.border = element_rect(colour = "black", linewidth = 1.4, fill = NA)  
  )









#all-subsets regression
### "tot.re.richness_ruqin"
library(MuMIn)
names.val2 <- names.val[-c(1:9,19,26,28,29,31,32,33)]   # 
ww <- dd[, c("tot.re.richness_ruqin", names.val2)] 
num_vars <- names(ww)[sapply(ww, is.numeric)][-1]
ww_scaled <- ww
ww_scaled[, num_vars] <- scale(ww[, num_vars])
fm <- lm(sqrt(tot.re.richness_ruqin)  ~ ., data = ww_scaled, na.action = na.fail)
ms1 <- dredge(fm, rank = "AICc")
summary(ms1)
ms1
get.models(ms1, 1)[[1]]

sw(ms1)


> summary(ms1)
  (Intercept)     guan_Faith_PD       guan_FD       guan_mpd.功能    guan_mpd.谱系    guan_ses.mpd_谱系 herb_Faith_PD       herb_FD      
 Min.   :0.1587   Min.   :-0.103   Min.   :-0.112   Min.   :-0.065   Min.   :-0.081   Min.   :-0.002    Min.   :-0.365   Min.   :-0.062  
 1st Qu.:0.1587   1st Qu.:-0.037   1st Qu.:-0.061   1st Qu.:-0.016   1st Qu.:-0.036   1st Qu.: 0.014    1st Qu.:-0.004   1st Qu.:-0.032  
 Median :0.1587   Median : 0.009   Median :-0.053   Median :-0.005   Median :-0.025   Median : 0.019    Median : 0.021   Median :-0.021  
 Mean   :0.1587   Mean   : 0.044   Mean   :-0.054   Mean   :-0.005   Mean   :-0.027   Mean   : 0.019    Mean   : 0.016   Mean   :-0.022  
 3rd Qu.:0.1587   3rd Qu.: 0.114   3rd Qu.:-0.044   3rd Qu.: 0.008   3rd Qu.:-0.016   3rd Qu.: 0.023    3rd Qu.: 0.044   3rd Qu.:-0.013  
 Max.   :0.1587   Max.   : 0.312   Max.   :-0.014   Max.   : 0.034   Max.   : 0.009   Max.   : 0.040    Max.   : 0.275   Max.   : 0.010  
                  NA's   :65536    NA's   :65536    NA's   :65536    NA's   :65536    NA's   :65536     NA's   :65536    NA's   :65536   
 herb_ses.mpd.功能 herb_ses.mpd_PD  mpd.谱系_herb    qiao_Faith_PD       qiao_FD       tot.cover_guan_all tot.cover_qiao   tot.richness_guan_all
 Min.   :-0.028    Min.   :-0.048   Min.   :-0.236   Min.   :-0.197   Min.   :-0.181   Min.   :-0.074     Min.   :-0.134   Min.   :-0.380       
 1st Qu.:-0.007    1st Qu.:-0.022   1st Qu.:-0.010   1st Qu.:-0.079   1st Qu.:-0.038   1st Qu.:-0.044     1st Qu.:-0.110   1st Qu.:-0.173       
 Median : 0.000    Median :-0.015   Median : 0.019   Median :-0.028   Median : 0.015   Median :-0.037     Median :-0.095   Median :-0.080       
 Mean   : 0.001    Mean   :-0.015   Mean   : 0.015   Mean   :-0.018   Mean   : 0.016   Mean   :-0.036     Mean   :-0.097   Mean   :-0.112       
 3rd Qu.: 0.008    3rd Qu.:-0.008   3rd Qu.: 0.038   3rd Qu.: 0.036   3rd Qu.: 0.068   3rd Qu.:-0.029     3rd Qu.:-0.086   3rd Qu.:-0.048       
 Max.   : 0.031    Max.   : 0.012   Max.   : 0.380   Max.   : 0.179   Max.   : 0.204   Max.   : 0.013     Max.   :-0.054   Max.   : 0.045       
 NA's   :65536     NA's   :65536    NA's   :65536    NA's   :65536    NA's   :65536    NA's   :65536      NA's   :65536    NA's   :65536        
 tot.richness_herb tot.richness_qiao       df           logLik           AICc            delta           weight         
 Min.   :-0.028    Min.   :-0.232    Min.   : 2.0   Min.   :21.26   Min.   :-80.22   Min.   : 0.00   Min.   :0.000e+00  
 1st Qu.:-0.015    1st Qu.:-0.089    1st Qu.: 9.0   1st Qu.:36.60   1st Qu.:-61.95   1st Qu.:18.27   1st Qu.:2.000e-10  
 Median :-0.008    Median :-0.010    Median :10.5   Median :39.86   Median :-52.16   Median :28.06   Median :5.700e-09  
 Mean   :-0.008    Mean   :-0.013    Mean   :10.5   Mean   :41.46   Mean   :-53.47   Mean   :26.75   Mean   :7.629e-06  
 3rd Qu.:-0.002    3rd Qu.: 0.063    3rd Qu.:12.0   3rd Qu.:46.97   3rd Qu.:-45.70   3rd Qu.:34.52   3rd Qu.:7.589e-07  
 Max.   : 0.033    Max.   : 0.185    Max.   :19.0   Max.   :52.65   Max.   :-19.83   Max.   :60.39   Max.   :7.054e-03  
 NA's   :65536     NA's   :65536                                                                                        
> ms1
Global model call: lm(formula = sqrt(tot.re.richness_ruqin) ~ ., data = ww_scaled, 
    na.action = na.fail)
---
Model selection table 
        (Int) gun_Fth_PD   gun_FD gun_mpd.功能 gun_mpd.谱系 gun_ses.mpd_谱系 hrb_Fth_PD     hrb_FD hrb_ses.mpd.功能 hrb_ses.mpd_PD mpd.谱系_hrb
12291  0.1587            -0.05026                                                                                                              
79891  0.1587            -0.06501                                  2.566e-02                                                                   
12323  0.1587            -0.05873                                             2.251e-02                                                        
78851  0.1587            -0.05000                                                                                                              
12307  0.1587            -0.05180                                  1.798e-02                                                                   
45059  0.1587            -0.05159                                                                                                              
12803  0.1587            -0.05773                                                                                                     2.059e-02
111619 0.1587            -0.05174                                                                                                              
12339  0.1587            -0.06002                                  1.749e-02  2.194e-02                                                        
12387  0.1587            -0.05794                                             2.666e-02 -1.897e-02                                             
79875  0.1587            -0.05807                                                                                                              
78867  0.1587            -0.05267                                  1.733e-02                                                                   
12355  0.1587            -0.04848                                                       -1.429e-02                                             
12819  0.1587            -0.05907                                  1.758e-02                                                          2.010e-02
12867  0.1587            -0.05698                                                       -1.915e-02                                    2.506e-02
12451  0.1587            -0.05628                                             2.766e-02                  -1.619e-02                            
79955  0.1587            -0.06430                                  2.594e-02            -1.539e-02                                             
45091  0.1587            -0.05863                                             1.928e-02                                                        
45571  0.1587            -0.05787                                                                                                     1.779e-02
12419  0.1587            -0.04764                                                                        -9.634e-03                            
45075  0.1587            -0.05265                                  1.500e-02                                                                   
12931  0.1587            -0.05524                                                                        -1.569e-02                   2.544e-02
80915  0.1587            -0.06239                                  2.343e-02                                                                   
61441  0.1587                                                                                                                                  
77827  0.1587            -0.04730                                                                                                              
12403  0.1587            -0.05922                                  1.702e-02  2.599e-02 -1.846e-02                                             
12547  0.1587            -0.05248                                                                                        7.241e-03             
12371  0.1587            -0.05006                                  1.770e-02            -1.387e-02                                             
12835  0.1587            -0.06114                                             1.574e-01                                              -1.333e-01
28675  0.1587            -0.04158                                                                                                              
112659 0.1587            -0.06504                                  2.306e-02                                                                   
80899  0.1587            -0.05544                                                                                                              
12295  0.1587            -0.05464    5.455e-03                                                                                                 
112643 0.1587            -0.05913                                                                                                              
12299  0.1587            -0.05154                 3.033e-03                                                                                    
12883  0.1587            -0.05830                                  1.711e-02            -1.863e-02                                    2.446e-02
12292  0.1587  1.525e-03 -0.05141                                                                                                              
14339  0.1587            -0.05057                                                                                                              
13315  0.1587            -0.05029                                                                                                              
28673  0.1587                                                                                                                                  
78883  0.1587            -0.05556                                             1.369e-02                                                        
79363  0.1587            -0.05484                                                                                                     1.255e-02
61443  0.1587            -0.03588                                                                                                              
       qia_Fth_PD     qia_FD tot.cvr_gun_all tot.cvr_qia tot.rch_gun_all tot.rch_hrb tot.rch_qia df logLik  AICc delta weight
12291                             -4.950e-02    -0.08406                                          5 45.946 -80.2  0.00  0.007
79891              1.396e-01      -3.517e-02    -0.11760                              -1.131e-01  8 50.200 -80.0  0.19  0.006
12323                             -4.663e-02    -0.09122                                          6 47.068 -79.7  0.49  0.006
78851   1.338e-01                 -4.936e-02    -0.11500                              -1.200e-01  7 48.494 -79.7  0.53  0.005
12307                             -4.816e-02    -0.08304                                          6 46.972 -79.5  0.68  0.005
45059                             -5.215e-02    -0.08759                  -1.822e-02              6 46.930 -79.5  0.76  0.005
12803                             -4.677e-02    -0.09030                                          6 46.914 -79.4  0.80  0.005
111619  1.366e-01                 -5.217e-02    -0.11970                  -1.876e-02  -1.213e-01  8 49.676 -79.0  1.24  0.004
12339                             -4.541e-02    -0.09005                                          7 48.091 -78.9  1.34  0.004
12387                             -4.820e-02    -0.08683                                          7 48.071 -78.8  1.38  0.004
79875              1.091e-01      -3.937e-02    -0.10910                              -9.466e-02  7 48.065 -78.8  1.39  0.004
78867   1.343e-01                 -4.832e-02    -0.11550                              -1.167e-01  8 49.539 -78.7  1.51  0.003
12355                             -5.108e-02    -0.07976                                          6 46.501 -78.6  1.62  0.003
12819                             -4.553e-02    -0.08915                                          7 47.941 -78.6  1.64  0.003
12867                             -4.830e-02    -0.08589                                          7 47.922 -78.5  1.68  0.003
12451                             -4.764e-02    -0.09653                                          7 47.822 -78.3  1.88  0.003
79955              1.434e-01      -3.668e-02    -0.11490                              -1.136e-01  9 50.974 -78.3  1.90  0.003
45091                             -4.926e-02    -0.09313                  -1.516e-02              7 47.758 -78.2  2.00  0.003
45571                             -4.944e-02    -0.09250                  -1.578e-02              7 47.665 -78.0  2.19  0.002
12419                             -5.049e-02    -0.08625                                          6 46.216 -78.0  2.19  0.002
45075                             -5.058e-02    -0.08612                  -1.503e-02              7 47.642 -78.0  2.24  0.002
12931                             -4.774e-02    -0.09532                                          7 47.618 -77.9  2.28  0.002
80915   7.388e-02  1.014e-01      -3.890e-02    -0.12650                              -1.448e-01  9 50.781 -77.9  2.29  0.002
61441                             -4.345e-02    -0.08673      -5.467e-02  -2.406e-02              6 46.131 -77.9  2.36  0.002
77827                             -4.888e-02    -0.08068                              -9.274e-03  6 46.130 -77.9  2.36  0.002
12403                             -4.697e-02    -0.08581                                          8 49.087 -77.8  2.41  0.002
12547                             -4.957e-02    -0.08579                                          6 46.078 -77.8  2.47  0.002
12371                             -4.972e-02    -0.07889                                          7 47.521 -77.7  2.48  0.002
12835                             -4.712e-02    -0.09376                                          7 47.516 -77.7  2.49  0.002
28675                             -4.615e-02    -0.08255      -1.225e-02                          6 46.054 -77.7  2.52  0.002
112659             1.336e-01      -3.755e-02    -0.11840                  -1.137e-02  -1.084e-01  9 50.637 -77.6  2.57  0.002
80899   9.622e-02  6.283e-02      -4.375e-02    -0.12170                              -1.381e-01  8 48.989 -77.6  2.61  0.002
12295                             -4.889e-02    -0.08398                                          6 45.984 -77.6  2.66  0.002
112643             1.049e-01      -4.220e-02    -0.11150                  -1.648e-02  -9.053e-02  8 48.949 -77.5  2.69  0.002
12299                             -4.978e-02    -0.08472                                          6 45.966 -77.5  2.69  0.002
12883                             -4.705e-02    -0.08489                                          8 48.942 -77.5  2.71  0.002
12292                             -4.981e-02    -0.08420                                          6 45.947 -77.5  2.73  0.002
14339              8.994e-04      -4.946e-02    -0.08455                                          6 45.947 -77.5  2.73  0.002
13315   1.278e-04                 -4.950e-02    -0.08413                                          6 45.946 -77.5  2.73  0.002
28673                             -4.258e-02    -0.08371      -4.867e-02                          5 44.561 -77.5  2.77  0.002
78883   1.183e-01                 -4.771e-02    -0.11620                              -1.049e-01  8 48.909 -77.5  2.77  0.002
79363   1.206e-01                 -4.777e-02    -0.11600                              -1.073e-01  8 48.863 -77.4  2.86  0.002
61443                             -4.642e-02    -0.08534      -2.247e-02  -2.094e-02              7 47.292 -77.3  2.93  0.002
 [ reached 'max' / getOption("max.print") -- omitted 131029 rows ]
Models ranked by AICc(x) 
> get.models(ms1, 1)[[1]]

Call:
lm(formula = sqrt(tot.re.richness_ruqin) ~ guan_FD + tot.cover_guan_all + 
    tot.cover_qiao + 1, data = ww_scaled, na.action = na.fail)

Coefficients:
       (Intercept)             guan_FD  tot.cover_guan_all      tot.cover_qiao  
           0.15867            -0.05026            -0.04950            -0.08406  

> sw(ms1)
                     tot.cover_qiao tot.cover_guan_all guan_FD tot.richness_qiao guan_ses.mpd_谱系 tot.richness_guan_all qiao_FD tot.richness_herb
Sum of weights:       1.00           0.86               0.73    0.39              0.38              0.35                  0.32    0.31            
N containing models: 65536          65536              65536   65536             65536             65536                 65536   65536            
                     herb_Faith_PD qiao_Faith_PD mpd.谱系_herb guan_Faith_PD herb_FD guan_mpd.谱系 herb_ses.mpd.功能 guan_mpd.功能 herb_ses.mpd_PD
Sum of weights:       0.29          0.28          0.27          0.26          0.24    0.22          0.20              0.19          0.18          
N containing models: 65536         65536         65536         65536         65536   65536         65536             65536         65536          
> mm <- lm(sqrt(tot.re.richness_ruqin)  ~ guan_FD+tot.cover_guan_all+tot.cover_qiao, data = ww_scaled)
> summary(mm)

Call:
lm(formula = sqrt(tot.re.richness_ruqin) ~ guan_FD + tot.cover_guan_all + 
    tot.cover_qiao, data = ww_scaled)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.209587 -0.046775  0.002133  0.046931  0.175703 

Coefficients:
                   Estimate Std. Error t value Pr(>|t|)    
(Intercept)         0.15867    0.01315  12.070 1.43e-14 ***
guan_FD            -0.05026    0.01535  -3.274  0.00226 ** 
tot.cover_guan_all -0.04950    0.01481  -3.341  0.00188 ** 
tot.cover_qiao     -0.08406    0.01454  -5.782 1.13e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.08519 on 38 degrees of freedom
Multiple R-squared:  0.6913,	Adjusted R-squared:  0.667 
F-statistic: 28.37 on 3 and 38 DF,  p-value: 8.42e-10




#VIF
> vars_needed <- c("tot.re.richness_ruqin", "guan_FD", "tot.cover_guan_all", "tot.cover_qiao")
> df <- subset(data, select = vars_needed)
> fm <- lm(sqrt(tot.re.richness_ruqin) ~ guan_FD + tot.cover_guan_all + tot.cover_qiao, data = df)
> car::vif(fm)
           guan_FD tot.cover_guan_all     tot.cover_qiao 
          1.330789           1.239823           1.194006 



### "tot.re.cover_ruqin"
library(MuMIn)
names.val2 <- names.val[-c(1:9,19,26,28,29,31,32,33)]  # 不包括响应变量
ww <- dd[, c("tot.re.cover_ruqin", names.val2)] 
num_vars <- names(ww)[sapply(ww, is.numeric)][-1]
ww_scaled <- ww
ww_scaled[, num_vars] <- scale(ww[, num_vars])
fm <- lm(sqrt(tot.re.cover_ruqin)  ~ ., data = ww_scaled, na.action = na.fail)
ms1 <- dredge(fm, rank = "AICc")
summary(ms1)
ms1
get.models(ms1, 1)[[1]]



> summary(ms1)
  (Intercept)     guan_Faith_PD       guan_FD       guan_mpd.功能    guan_mpd.谱系    guan_ses.mpd_谱系 herb_Faith_PD       herb_FD      
 Min.   :0.1142   Min.   :-0.264   Min.   :-0.116   Min.   :-0.060   Min.   :-0.064   Min.   :-0.033    Min.   :-0.292   Min.   :-0.060  
 1st Qu.:0.1142   1st Qu.:-0.080   1st Qu.:-0.057   1st Qu.:-0.004   1st Qu.:-0.014   1st Qu.:-0.007    1st Qu.:-0.006   1st Qu.:-0.036  
 Median :0.1142   Median :-0.056   Median :-0.039   Median : 0.006   Median :-0.005   Median :-0.002    Median : 0.021   Median :-0.027  
 Mean   :0.1142   Mean   :-0.046   Mean   :-0.044   Mean   : 0.003   Mean   :-0.006   Mean   :-0.003    Mean   : 0.094   Mean   :-0.028  
 3rd Qu.:0.1142   3rd Qu.:-0.016   3rd Qu.:-0.028   3rd Qu.: 0.015   3rd Qu.: 0.003   3rd Qu.: 0.002    3rd Qu.: 0.192   3rd Qu.:-0.020  
 Max.   :0.1142   Max.   : 0.142   Max.   : 0.006   Max.   : 0.036   Max.   : 0.049   Max.   : 0.020    Max.   : 0.547   Max.   : 0.003  
                  NA's   :131072   NA's   :131072   NA's   :131072   NA's   :131072   NA's   :131072    NA's   :131072   NA's   :131072  
 herb_ses.mpd.功能 herb_ses.mpd_PD  mpd.谱系_herb    qiao_Faith_PD       qiao_FD       qiao_mpd.谱系    tot.cover_guan_all tot.cover_qiao  
 Min.   :-0.022    Min.   :-0.063   Min.   :-0.511   Min.   :-0.300   Min.   :-0.239   Min.   :-0.031   Min.   :-0.085     Min.   :-0.114  
 1st Qu.: 0.009    1st Qu.:-0.040   1st Qu.:-0.193   1st Qu.:-0.039   1st Qu.:-0.069   1st Qu.: 0.007   1st Qu.:-0.046     1st Qu.:-0.080  
 Median : 0.016    Median :-0.035   Median :-0.027   Median : 0.015   Median :-0.022   Median : 0.023   Median :-0.039     Median :-0.071  
 Mean   : 0.017    Mean   :-0.035   Mean   :-0.097   Mean   :-0.001   Mean   :-0.029   Mean   : 0.021   Mean   :-0.040     Mean   :-0.070  
 3rd Qu.: 0.026    3rd Qu.:-0.029   3rd Qu.:-0.003   3rd Qu.: 0.058   3rd Qu.: 0.017   3rd Qu.: 0.031   3rd Qu.:-0.032     3rd Qu.:-0.062  
 Max.   : 0.043    Max.   :-0.012   Max.   : 0.271   Max.   : 0.202   Max.   : 0.126   Max.   : 0.063   Max.   :-0.002     Max.   :-0.025  
 NA's   :131072    NA's   :131072   NA's   :131072   NA's   :131072   NA's   :131072   NA's   :131072   NA's   :131072     NA's   :131072  
 tot.richness_guan_all tot.richness_herb tot.richness_qiao       df         logLik           AICc             delta           weight         
 Min.   :-0.245        Min.   :-0.050    Min.   :-0.174    Min.   : 2   Min.   :19.63   Min.   :-58.317   Min.   : 0.00   Min.   :0.000e+00  
 1st Qu.:-0.098        1st Qu.:-0.036    1st Qu.:-0.002    1st Qu.:10   1st Qu.:32.42   1st Qu.:-41.866   1st Qu.:16.45   1st Qu.:1.274e-08  
 Median :-0.072        Median :-0.030    Median : 0.035    Median :11   Median :34.48   Median :-37.801   Median :20.52   Median :1.101e-07  
 Mean   :-0.062        Mean   :-0.029    Mean   : 0.049    Mean   :11   Mean   :34.46   Mean   :-37.531   Mean   :20.79   Mean   :3.815e-06  
 3rd Qu.:-0.037        3rd Qu.:-0.024    3rd Qu.: 0.096    3rd Qu.:12   3rd Qu.:36.80   3rd Qu.:-33.489   3rd Qu.:24.83   3rd Qu.:8.400e-07  
 Max.   : 0.251        Max.   : 0.007    Max.   : 0.309    Max.   :20   Max.   :42.35   Max.   : -4.708   Max.   :53.61   Max.   :3.138e-03  
 NA's   :131072        NA's   :131072    NA's   :131072                                                                                      
> ms1
Global model call: lm(formula = sqrt(tot.re.cover_ruqin) ~ ., data = ww_scaled, 
    na.action = na.fail)
---
Model selection table 
        (Int) gun_Fth_PD     gun_FD gun_mpd.功能 gun_mpd.谱系 gun_ses.mpd_谱系 hrb_Fth_PD     hrb_FD hrb_ses.mpd.功能 hrb_ses.mpd_PD mpd.谱系_hrb
90114  0.1142 -6.452e-02                                                                                                                         
90115  0.1142            -5.871e-02                                                                                                              
24579  0.1142            -5.660e-02                                                                                                              
91138  0.1142 -8.065e-02                                                                                                                         
90370  0.1142 -5.903e-02                                                                                                    -0.02481             
28675  0.1142            -5.887e-02                                                                                                              
115713 0.1142                                                                                                                                    
123905 0.1142                                                                                                                                    
115969 0.1142                                                                                                               -0.02784             
94210  0.1142 -6.556e-02                                                                                                                         
94211  0.1142            -6.058e-02                                                                                                              
124161 0.1142                                                                                                               -0.02677             
123137 0.1142                                                                                                               -0.02919             
122881 0.1142                                                                                                                                    
116737 0.1142                                                                                                                                    
116993 0.1142                                                                                                               -0.02865             
24578  0.1142 -5.571e-02                                                                                                                         
221186 0.1142 -7.572e-02                                                                                                                         
24643  0.1142            -5.395e-02                                                       -2.132e-02                                             
92162  0.1142 -7.688e-02                                                                                                                         
90371  0.1142            -5.238e-02                                                                                         -0.02058             
245761 0.1142                                                                                                                                    
253953 0.1142                                                                                                                                    
90116  0.1142 -3.797e-02 -3.041e-02                                                                                                              
94466  0.1142 -5.999e-02                                                                                                    -0.02523             
24835  0.1142            -5.030e-02                                                                                         -0.02049             
81922  0.1142 -8.700e-02                                                                                                                         
91394  0.1142 -7.414e-02                                                                                                    -0.02228             
90626  0.1142 -5.909e-02                                                                                                               -1.586e-02
246017 0.1142                                                                                                               -0.02799             
90178  0.1142 -6.184e-02                                                                  -1.451e-02                                             
114945 0.1142                                                                                                               -0.03095             
124929 0.1142                                                                                                                                    
90146  0.1142 -5.932e-02                                                       -1.457e-02                                                        
95234  0.1142 -8.026e-02                                                                                                                         
90179  0.1142            -5.647e-02                                                       -1.630e-02                                             
28674  0.1142 -5.746e-02                                                                                                                         
254209 0.1142                                                                                                               -0.02698             
93186  0.1142 -7.498e-02                                                                                                                         
28931  0.1142            -5.253e-02                                                                                         -0.02064             
82946  0.1142 -1.035e-01                                                                                                                         
       qia_Fth_PD     qia_FD qia_mpd.谱系 tot.cvr_gun_all tot.cvr_qia tot.rch_gun_all tot.rch_hrb tot.rch_qia df logLik  AICc delta weight
90114                                           -0.042370    -0.06619                  -3.644e-02              6 36.359 -58.3  0.00  0.003
90115                                           -0.050210    -0.06653                  -2.876e-02              6 36.202 -58.0  0.31  0.003
24579                                           -0.046020    -0.06096                                          5 34.746 -57.8  0.49  0.002
91138   3.529e-02                               -0.040880    -0.08449                  -3.997e-02              7 37.456 -57.6  0.70  0.002
90370                                           -0.041750    -0.05942                  -3.601e-02              7 37.410 -57.5  0.79  0.002
28675                           2.998e-02       -0.044420    -0.07652                                          6 35.919 -57.4  0.88  0.002
115713  5.545e-02                                            -0.08047      -1.143e-01  -4.104e-02              6 35.911 -57.4  0.90  0.002
123905  4.791e-02                               -0.033720    -0.08770      -9.059e-02  -4.102e-02              7 37.348 -57.4  0.92  0.002
115969  5.164e-02                                            -0.07077      -1.077e-01  -4.061e-02              7 37.242 -57.2  1.13  0.002
94210                           2.492e-02       -0.040910    -0.07897                  -3.440e-02              7 37.222 -57.2  1.17  0.002
94211                           2.696e-02       -0.048440    -0.08008                  -2.646e-02              7 37.204 -57.1  1.20  0.002
124161  4.452e-02                               -0.032520    -0.07812      -8.510e-02  -4.062e-02              8 38.663 -57.0  1.35  0.002
123137                                          -0.038230    -0.05664      -5.891e-02  -3.548e-02              7 37.111 -56.9  1.39  0.002
122881                                          -0.040020    -0.06537      -6.275e-02  -3.549e-02              6 35.654 -56.9  1.41  0.002
116737             5.201e-02                                 -0.07988      -1.118e-01  -3.979e-02              6 35.559 -56.7  1.60  0.001
116993             4.881e-02                                 -0.07020      -1.055e-01  -3.949e-02              7 36.952 -56.6  1.71  0.001
24578                                           -0.040470    -0.06132                                          5 34.135 -56.6  1.71  0.001
221186                                          -0.041390    -0.07329                  -3.880e-02   2.210e-02  7 36.942 -56.6  1.73  0.001
24643                                           -0.048370    -0.05455                                          6 35.474 -56.5  1.77  0.001
92162              2.547e-02                    -0.039110    -0.07931                  -3.847e-02              7 36.890 -56.5  1.83  0.001
90371                                           -0.050000    -0.06164                  -2.881e-02              7 36.880 -56.5  1.85  0.001
245761                                                       -0.06511      -1.112e-01  -4.012e-02   4.233e-02  6 35.401 -56.4  1.92  0.001
253953                                          -0.034290    -0.07419      -8.670e-02  -4.006e-02   3.517e-02  7 36.844 -56.4  1.92  0.001
90116                                           -0.043140    -0.06417                  -3.365e-02              7 36.842 -56.4  1.93  0.001
94466                           2.542e-02       -0.040260    -0.07235                  -3.392e-02              8 38.357 -56.4  1.97  0.001
24835                                           -0.045800    -0.05608                                          6 35.373 -56.3  1.97  0.001
81922                                                        -0.05319                  -3.469e-02              5 33.990 -56.3  2.00  0.001
91394   3.185e-02                               -0.040470    -0.07663                  -3.924e-02              8 38.335 -56.3  2.01  0.001
90626                                           -0.045190    -0.06161                  -3.801e-02              7 36.718 -56.1  2.18  0.001
246017                                                       -0.05619      -1.043e-01  -3.966e-02   3.866e-02  7 36.710 -56.1  2.19  0.001
90178                                           -0.044100    -0.06149                  -3.348e-02              7 36.703 -56.1  2.20  0.001
114945                                                       -0.04360      -8.123e-02  -3.448e-02              6 35.255 -56.1  2.21  0.001
124929             3.958e-02                    -0.031100    -0.08348      -8.737e-02  -3.932e-02              7 36.677 -56.1  2.26  0.001
90146                                           -0.044960    -0.06183                  -3.816e-02              7 36.648 -56.0  2.31  0.001
95234   3.242e-02               2.229e-02       -0.039700    -0.09445                  -3.786e-02              8 38.174 -56.0  2.33  0.001
90179                                           -0.051590    -0.06106                  -2.582e-02              7 36.638 -56.0  2.33  0.001
28674                           2.854e-02       -0.038920    -0.07628                                          6 35.167 -55.9  2.38  0.001
254209                                          -0.033180    -0.06530      -8.090e-02  -3.962e-02   3.186e-02  8 38.146 -55.9  2.39  0.001
93186   1.154e-01 -8.720e-02                    -0.048640    -0.08113                  -4.104e-02              8 38.134 -55.9  2.41  0.001
28931                           3.009e-02       -0.044190    -0.07167                                          7 36.593 -55.9  2.43  0.001
82946   3.809e-02                                            -0.07344                  -3.857e-02              6 35.137 -55.9  2.44  0.001
 [ reached 'max' / getOption("max.print") -- omitted 262103 rows ]
Models ranked by AICc(x) 
> get.models(ms1, 1)[[1]]

Call:
lm(formula = sqrt(tot.re.cover_ruqin) ~ guan_Faith_PD + tot.cover_guan_all + 
    tot.cover_qiao + tot.richness_herb + 1, data = ww_scaled, 
    na.action = na.fail)

Coefficients:
       (Intercept)       guan_Faith_PD  tot.cover_guan_all      tot.cover_qiao   tot.richness_herb  
           0.11423            -0.06452            -0.04237            -0.06619            -0.03644  
		   
		   
mm <- lm(sqrt(tot.re.cover_ruqin)  ~ guan_Faith_PD+tot.cover_guan_all+tot.cover_qiao+tot.richness_herb, data = ww_scaled)
summary(mm)		   
		   
Call:
lm(formula = sqrt(tot.re.cover_ruqin) ~ guan_Faith_PD + tot.cover_guan_all + 
    tot.cover_qiao + tot.richness_herb, data = ww_scaled)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.16017 -0.07905 -0.01477  0.04482  0.29461 

Coefficients:
                   Estimate Std. Error t value Pr(>|t|)    
(Intercept)         0.11423    0.01674   6.825 4.86e-08 ***
guan_Faith_PD      -0.06452    0.02120  -3.043  0.00429 ** 
tot.cover_guan_all -0.04237    0.02016  -2.102  0.04244 *  
tot.cover_qiao     -0.06619    0.01883  -3.516  0.00118 ** 
tot.richness_herb  -0.03644    0.01792  -2.033  0.04926 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1085 on 37 degrees of freedom
Multiple R-squared:  0.5491,	Adjusted R-squared:  0.5004 
F-statistic: 11.27 on 4 and 37 DF,  p-value: 4.445e-06		   
		   
	
	  
##VIF
> vars_needed2 <- c("tot.re.cover_ruqin", "guan_Faith_PD", "tot.cover_guan_all", "tot.cover_qiao","tot.richness_herb")
> dff <- subset(data, select = vars_needed2)
> fmm <- lm(sqrt(tot.re.cover_ruqin) ~ guan_Faith_PD + tot.cover_guan_all + tot.cover_qiao +tot.richness_herb, data = dff)
> car::vif(fmm)
     guan_Faith_PD tot.cover_guan_all     tot.cover_qiao  tot.richness_herb 
          1.566179           1.415987           1.234959           1.119373 







#randomForest
library(randomForest)
library(fastshap)
library(ggplot2)
dd = read.csv("汇总.csv",fileEncoding= "UTF-8")
dd$log.year =log(dd$year)
dd$way <- factor(dd$way, levels = c("RG", "TR"))
dd$way_num <- as.numeric(factor(dd$way, levels = c("RG", "TR"))) - 1
ee <- dd[, c("tot.re.richness_ruqin", "guan_FD", "tot.cover_guan_all", "tot.cover_qiao", 
               "PC1","PC2","PC3","way_num","log.year")]
fit <- randomForest(
  sqrt(tot.re.richness_ruqin) ~ ., data = ee, importance = TRUE, na.action = na.omit,mtry = 3,ntree = 500)

pfun <- function(object, newdata) {
  predict(object, newdata = newdata)
}

set.seed(101)
shap <- explain( fit,
  X = subset(ee, select = -sqrt(tot.re.richness_ruqin)),
  nsim = 100,
  pred_wrapper = pfun,
  adjust = TRUE,
  shap_only = TRUE
)


shap2 <- as.data.frame(shap)
shap2 <- abs(shap2)  # 

mean_shap <- colMeans(shap2, na.rm = TRUE)

chart3 <- data.frame(
  Var = names(mean_shap),
  Value = as.numeric(mean_shap)
)

chart3 <- chart3[order(chart3$Value), ]
chart3$Var <- factor(chart3$Var, levels = chart3$Var)

pim <- ggplot(chart3) +
  geom_col(aes(Var, Value),
           fill="gray",
           color="transparent",
           alpha=0.5) +
  coord_flip() +  # 
  scale_y_continuous(limits=c(0,NA)) +
  theme_bw() +  # 
  theme(
    axis.title = element_text(size=18, lineheight = 1),
    axis.text = element_text(color="black", size=18), 
    panel.border = element_rect(linewidth = 1, color = "black"),  #
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.ticks.length.y = unit(0.4, "cm"), 
    axis.ticks.length.x = unit(0.3, "cm"), 
    axis.ticks.y = element_line(color="black", linewidth = 1),
    axis.ticks.x = element_line(color="black", linewidth = 1),
    axis.line.x.top = element_blank(), # 
    axis.line.y.right = element_blank() # 
  ) +
  labs(x=NULL, y="Mean absolute SHAP value")
pim



library(randomForest)
library(fastshap)
library(ggplot2)
dd = read.csv("汇总.csv",fileEncoding= "UTF-8")
dd$log.year =log(dd$year)
dd$way <- factor(dd$way, levels = c("RG", "TR"))
dd$way_num <- as.numeric(factor(dd$way, levels = c("RG", "TR"))) - 1
ee <- dd[, c("tot.re.cover_ruqin", "guan_Faith_PD", "tot.cover_guan_all", "tot.cover_qiao", 
             "tot.richness_herb", "PC1","PC2","PC3","way_num","log.year")]
fit <- randomForest(
  sqrt(tot.re.cover_ruqin) ~ ., data = ee, importance = TRUE, na.action = na.omit,mtry = 3,ntree = 500)

pfun <- function(object, newdata) {
  predict(object, newdata = newdata)
}

set.seed(101)
shap <- explain( fit,
                 X = subset(ee, select = -sqrt(tot.re.cover_ruqin)),
                 nsim = 100,
                 pred_wrapper = pfun,
                 adjust = TRUE,
                 shap_only = TRUE
)


shap2 <- as.data.frame(shap)
shap2 <- abs(shap2)  # 

mean_shap <- colMeans(shap2, na.rm = TRUE)

chart3 <- data.frame(
  Var = names(mean_shap),
  Value = as.numeric(mean_shap)
)

chart3 <- chart3[order(chart3$Value), ]
chart3$Var <- factor(chart3$Var, levels = chart3$Var)

pim <- ggplot(chart3) +
  geom_col(aes(Var, Value),
           fill="gray",
           color="transparent",
           alpha=0.5) +
  coord_flip() +  
  scale_y_continuous(limits=c(0,NA)) +
  theme_bw() +  
  theme(
    axis.title = element_text(size=18, lineheight = 1),
    axis.text = element_text(color="black", size=18), 
    panel.border = element_rect(linewidth = 1, color = "black"),  
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.ticks.length.y = unit(0.4, "cm"), 
    axis.ticks.length.x = unit(0.3, "cm"), 
    axis.ticks.y = element_line(color="black", linewidth = 1),
    axis.ticks.x = element_line(color="black", linewidth = 1),
    axis.line.x.top = element_blank(), 
    axis.line.y.right = element_blank() 
  ) +
  labs(x=NULL, y="Mean absolute SHAP value")
pim




##piecewiseSEM
library("piecewiseSEM")
m1 <- lm(sqrt(tot.re.richness_ruqin) ~ tot.cover_qiao+tot.cover_guan_all+guan_FD  , data =  xx_scaled)#PC1+PC2+log.year+ +way_num+ PC3
m2<- lm(tot.cover_qiao~ log.year+way_num , data = xx_scaled)#
m3 <- lm(tot.cover_guan_all ~ tot.cover_qiao  +PC2 +log.year, data = xx_scaled)#+way_num+PC3+PC1
m4 <- lm(guan_FD ~log.year, data = xx_scaled)#tot.cover_qiao  +PC3 +PC1++way_num PC2+



#m5<- lm(PC1 ~ tot.cover_qiao+log.year+way_num , data = xx_scaled)#
m6<- lm(PC2 ~ log.year , data = xx_scaled)#tot.cover_qiao++way_num
#m7<- lm(PC3 ~ tot.cover_qiao+log.year+way_num , data = xx_scaled)# 


# 合并为 Piecewise SEM  ,m7,m5
sem_model <- psem(m1,m2, m3,m4,m6)  
model_summary = summary(sem_model, AIC.type = "loglik")

k = AIC(sem_model)[[2]];
n = AIC(sem_model)[[3]];
aicc <- AIC(sem_model)[[1]] + (2 * k * (k + 1)) / (n - k - 1)  
aicc
model_summary
> aicc
[1] 365.462
> model_summary

Structural Equation Model of sem_model 

Call:
  sqrt(tot.re.richness_ruqin) ~ tot.cover_qiao + tot.cover_guan_all + guan_FD
  tot.cover_qiao ~ log.year + way_num
  tot.cover_guan_all ~ tot.cover_qiao + PC2 + log.year
  guan_FD ~ log.year
  PC2 ~ log.year

    AIC
 325.462

---
Tests of directed separation:

                                Independ.Claim Test.Type DF Crit.Value P.Value 
  sqrt(tot.re.richness_ruqin) ~ log.year + ...      coef 37    -0.8033  0.4269 
            tot.cover_guan_all ~ way_num + ...      coef 37     1.3702  0.1789 
                       guan_FD ~ way_num + ...      coef 39     1.0751  0.2889 
                           PC2 ~ way_num + ...      coef 39     0.9327  0.3567 
   sqrt(tot.re.richness_ruqin) ~ way_num + ...      coef 37    -1.0887  0.2833 
                guan_FD ~ tot.cover_qiao + ...      coef 38     0.1319  0.8957 
                    PC2 ~ tot.cover_qiao + ...      coef 38     0.0145  0.9885 
            guan_FD ~ tot.cover_guan_all + ...      coef 37    -0.2694  0.7891 
                           PC2 ~ guan_FD + ...      coef 39    -1.3827  0.1746 
       sqrt(tot.re.richness_ruqin) ~ PC2 + ...      coef 36    -0.6049  0.5491 

--
Global goodness-of-fit:

Chi-Squared = 12.8 with P-value = 0.307 and on 11 degrees of freedom
Fisher's C = 17.618 with P-value = 0.613 and on 20 degrees of freedom

---
Coefficients:

                     Response          Predictor Estimate Std.Error DF Crit.Value P.Value Std.Estimate    
  sqrt(tot.re.richness_ruqin)     tot.cover_qiao  -0.0841    0.0145 38    -5.7821  0.0000      -0.5694 ***
  sqrt(tot.re.richness_ruqin) tot.cover_guan_all  -0.0495    0.0148 38    -3.3410  0.0019      -0.3353  **
  sqrt(tot.re.richness_ruqin)            guan_FD  -0.0503    0.0153 38    -3.2744  0.0023      -0.3404  **
               tot.cover_qiao           log.year   0.3540    0.1283 39     2.7598  0.0088       0.3540  **
               tot.cover_qiao            way_num  -0.4508    0.1283 39    -3.5144  0.0011      -0.4508  **
           tot.cover_guan_all     tot.cover_qiao  -0.3951    0.1305 38    -3.0276  0.0044      -0.3951  **
           tot.cover_guan_all                PC2   0.3105    0.1258 38     2.4672  0.0182       0.3105   *
           tot.cover_guan_all           log.year   0.7462    0.1354 38     5.5125  0.0000       0.7462 ***
                      guan_FD           log.year   0.8116    0.0924 40     8.7869  0.0000       0.8116 ***
                          PC2           log.year  -0.3248    0.1495 40    -2.1722  0.0358      -0.3248   *

  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05

---
Individual R-squared:

               Response method R.squared
  tot.re.richness_ruqin   none      0.69
         tot.cover_qiao   none      0.37
     tot.cover_guan_all   none      0.46
                guan_FD   none      0.66
                    PC2   none      0.11	





library(ggplot2)
library(dplyr)



data <- data.frame(
  Variable = c("log.year", "way_num", "tot.cover_qiao", "tot.cover_qiao", 
               "tot.cover_guan_all", "guan_FD", 
               "PC2"),
  EffectType = c("indirect", "indirect", "direct", "indirect", 
                 "direct", "direct",  "indirect"),
  Value = c(-0.694222, 0.2566855, -0.5694, 0.132477, 
            -0.3353, -0.3404, -0.1041106))
data <- data %>%
  mutate(pos = ifelse(EffectType == "direct", 1, 2))
data$Variable <- factor(data$Variable, levels = rev(c(
  "log.year", "way_num", "tot.cover_qiao", 
  "tot.cover_guan_all", "guan_FD", 
  "PC2")))
ggplot(data, aes(x = Value, y = Variable, fill = EffectType)) +
  geom_col(position = position_stack(reverse = TRUE), width = 0.8, color = "gray40", size = 0.8) +
  scale_fill_manual(values = c("direct" = "gray60", "indirect" = "white")) +
  geom_vline(xintercept = 0, linetype = "dashed", color ="black", size = 1.2) +
  scale_x_continuous(limits = c(-0.80, 0.30), breaks = seq(-0.80, 30, by = 0.20)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.title.x = element_text(size = 14),
    axis.line.x = element_line(color = "black", size = 0.8),
    axis.ticks.x = element_line(color = "black", size = 0.8),
    axis.ticks.length = unit(0.25, "cm"),
    legend.position = "none"
  ) +
  labs(x = "Effect size")






#piecewiseSEM
m1 <- lm(sqrt(tot.re.cover_ruqin) ~ tot.cover_qiao  +tot.cover_guan_all+guan_Faith_PD+
           tot.richness_herb , data =  xx_scaled)#PC2++way_num+PC1+log.year+PC3
m2<- lm(tot.cover_qiao~ log.year+way_num, data = xx_scaled)#


m3 <- lm(guan_Faith_PD ~ log.year+way_num, data = xx_scaled)#tot.cover_qiao +PC1+PC2+PC3 +
m4 <- lm(tot.cover_guan_all ~ tot.cover_qiao +PC2 +log.year, data = xx_scaled)#+way_num+PC3+PC1

#m5<- lm(tot.richness_herb~ guan_Faith_PD
#        , data = xx_scaled)#PC2++way_num+log.year+tot.cover_guan_alltot.cover_qiao ++PC1 +PC3


#m6<- lm(PC1 ~ tot.cover_qiao +log.year+way_num , data = xx_scaled)#
m7<- lm(PC2 ~log.year , data = xx_scaled)# tot.cover_qiao ++way_num
#m8<- lm(PC3 ~ tot.cover_qiao  +log.year+way_num , data = xx_scaled)# 


# 合并为 Piecewise SEM  m6,,m8m5,
sem_model <- psem(m1,m2, m3,m4,m7)  
model_summary = summary(sem_model, AIC.type = "loglik")

k = AIC(sem_model)[[2]];
n = AIC(sem_model)[[3]];
aicc <- AIC(sem_model)[[1]] + (2 * k * (k + 1)) / (n - k - 1)  # k=参数数, n=样本量
aicc
model_summary
> aicc
[1] 399.4142
> model_summary

Structural Equation Model of sem_model 

Call:
  sqrt(tot.re.cover_ruqin) ~ tot.cover_qiao + tot.cover_guan_all + guan_Faith_PD + tot.richness_herb
  tot.cover_qiao ~ log.year + way_num
  guan_Faith_PD ~ log.year + way_num
  tot.cover_guan_all ~ tot.cover_qiao + PC2 + log.year
  PC2 ~ log.year

    AIC
 346.151

---
Tests of directed separation:

                                Independ.Claim Test.Type DF Crit.Value P.Value  
      tot.cover_qiao ~ tot.richness_herb + ...      coef 38    -0.7695  0.4464  
  tot.cover_guan_all ~ tot.richness_herb + ...      coef 37    -0.8852  0.3817  
       guan_Faith_PD ~ tot.richness_herb + ...      coef 38    -1.7238  0.0929  
                 PC2 ~ tot.richness_herb + ...      coef 39     0.2833  0.7784  
     sqrt(tot.re.cover_ruqin) ~ log.year + ...      coef 36    -2.0780  0.0449 *
            tot.cover_guan_all ~ way_num + ...      coef 37     1.3702  0.1789  
                           PC2 ~ way_num + ...      coef 39     0.9327  0.3567  
      sqrt(tot.re.cover_ruqin) ~ way_num + ...      coef 36     1.0490  0.3012  
          guan_Faith_PD ~ tot.cover_qiao + ...      coef 38     0.6391  0.5266  
                    PC2 ~ tot.cover_qiao + ...      coef 38     0.0145  0.9885  
      guan_Faith_PD ~ tot.cover_guan_all + ...      coef 36     0.5644  0.5760  
                     PC2 ~ guan_Faith_PD + ...      coef 38    -1.0655  0.2934  
          sqrt(tot.re.cover_ruqin) ~ PC2 + ...      coef 35    -0.0494  0.9609  

--
Global goodness-of-fit:

Chi-Squared = 15.526 with P-value = 0.343 and on 14 degrees of freedom
Fisher's C = 27.845 with P-value = 0.366 and on 26 degrees of freedom

---
Coefficients:

                  Response          Predictor Estimate Std.Error DF Crit.Value P.Value Std.Estimate    
  sqrt(tot.re.cover_ruqin)     tot.cover_qiao  -0.0662    0.0188 37    -3.5156  0.0012      -0.4313  **
  sqrt(tot.re.cover_ruqin) tot.cover_guan_all  -0.0424    0.0202 37    -2.1018  0.0424      -0.2761   *
  sqrt(tot.re.cover_ruqin)      guan_Faith_PD  -0.0645    0.0212 37    -3.0434  0.0043      -0.4205  **
  sqrt(tot.re.cover_ruqin)  tot.richness_herb  -0.0364    0.0179 37    -2.0332  0.0493      -0.2375   *
            tot.cover_qiao           log.year   0.3540    0.1283 39     2.7598  0.0088       0.3540  **
            tot.cover_qiao            way_num  -0.4508    0.1283 39    -3.5144  0.0011      -0.4508  **
             guan_Faith_PD           log.year   0.8234    0.0915 39     8.9960  0.0000       0.8234 ***
             guan_Faith_PD            way_num   0.2070    0.0915 39     2.2619  0.0294       0.2070   *
        tot.cover_guan_all     tot.cover_qiao  -0.3951    0.1305 38    -3.0276  0.0044      -0.3951  **
        tot.cover_guan_all                PC2   0.3105    0.1258 38     2.4672  0.0182       0.3105   *
        tot.cover_guan_all           log.year   0.7462    0.1354 38     5.5125  0.0000       0.7462 ***
                       PC2           log.year  -0.3248    0.1495 40    -2.1722  0.0358      -0.3248   *

  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05

---
Individual R-squared:

            Response method R.squared
  tot.re.cover_ruqin   none      0.55
      tot.cover_qiao   none      0.37
       guan_Faith_PD   none      0.68
  tot.cover_guan_all   none      0.46
                 PC2   none      0.11





data <- data.frame(
  Variable = c("log.year", "way_num", "tot.cover_qiao", "tot.cover_qiao", 
               "tot.cover_guan_all", "guan_Faith_PD", 
               "tot.richness_herb", "PC2"),
  EffectType = c("indirect", "indirect", "direct", "indirect", 
                 "direct", "direct", "direct", "indirect"),
  Value = c(-0.6771009, 0.1073865, -0.4313, 0.1704066, 
            -0.2761, -0.4205, -0.2375, -0.08572905))
data <- data %>%
  mutate(pos = ifelse(EffectType == "direct", 1, 2))
data$Variable <- factor(data$Variable, levels = rev(c(
  "log.year", "way_num", "tot.cover_qiao", "tot.cover_guan_all",
  "guan_Faith_PD", "tot.richness_herb", "PC2")))
ggplot(data, aes(x = Value, y = Variable, fill = EffectType)) +
  geom_col(position = position_stack(reverse = TRUE), width = 0.8, color = "gray40", size = 0.8) +
  scale_fill_manual(values = c("direct" = "gray60", "indirect" = "white")) +
  geom_vline(xintercept = 0, linetype = "dashed", color ="black", size = 1.2) +
  scale_x_continuous(limits = c(-0.75, 0.25), breaks = seq(-0.75, 0.25, by = 0.25)) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.title.x = element_text(size = 14),
    axis.line.x = element_line(color = "black", size = 0.8),
    axis.ticks.x = element_line(color = "black", size = 0.8),
    axis.ticks.length = unit(0.25, "cm"),
    legend.position = "none"
  ) +
  labs(x = "Effect size")



